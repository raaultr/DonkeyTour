{% extends 'base.html.twig' %}

{% block title %}Reserva #{{ reserve.id }} ¬∑ DonkeyTour Admin{% endblock %}
{% block page_title %}Detalle de Reserva #{{ reserve.id }}{% endblock %}

{% block body %}
{# Contenedor principal centrado #}
<div class="flex justify-center w-full min-h-screen bg-[#FCFAF7]/50 p-4">
    <div class="w-full max-w-4xl space-y-8">

        {% for type, messages in app.flashes %}
            {% for msg in messages %}
                <div class="px-5 py-3 rounded-2xl text-sm font-bold {{ type == 'error' ? 'bg-red-50 text-red-600 border border-red-100' : 'bg-green-50 text-green-600 border border-green-100' }}">
                    {{ msg }}
                </div>
            {% endfor %}
        {% endfor %}

        {# Volver #}
        <a href="{{ path('app_admin_reserve_index') }}" class="group text-stone-500 font-bold hover:text-[#8B5E3C] transition-colors text-xs uppercase tracking-widest flex items-center gap-2 w-fit">
            <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Volver al listado
        </a>

        {# Cabecera #}
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6 bg-white p-6 rounded-[2rem] border border-stone-100 shadow-sm">
            <div>
                <div class="flex items-center gap-3">
                    <h1 class="text-3xl font-extrabold text-[#3E2F28] tracking-tight">Reserva <span class="text-[#8B5E3C]">#{{ reserve.id }}</span></h1>
                    <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border
                                 {{ reserve.state ? 'bg-green-50 text-green-600 border-green-100' : 'bg-red-50 text-red-500 border-red-100' }}">
                        {{ reserve.state ? 'Activa' : 'Cancelada' }}
                    </span>
                </div>
                <p class="text-stone-400 text-[10px] font-bold uppercase tracking-[0.2em] mt-2">Creada el {{ reserve.createdAt ? reserve.createdAt|date('d/m/Y H:i') : '‚Äî' }}</p>
            </div>

            {# Bot√≥n cambiar estado #}
            <form method="post" action="{{ path('app_admin_reserve_toggle', {'id': reserve.id}) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('toggle' ~ reserve.id) }}">
                <button type="submit"
                        class="px-6 py-3 rounded-xl font-bold text-[10px] uppercase tracking-widest transition-all border-2
                               {{ reserve.state ? 'border-red-100 text-red-500 hover:bg-red-500 hover:text-white hover:border-red-500' : 'border-green-100 text-green-600 hover:bg-green-600 hover:text-white hover:border-green-600' }}">
                    {{ reserve.state ? 'Cancelar reserva' : 'Reactivar reserva' }}
                </button>
            </form>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            {# ---- Info principal ---- #}
            <div class="bg-white/80 backdrop-blur-xl border border-stone-100 rounded-[2.5rem] p-8 shadow-sm space-y-6">
                <div class="flex items-center gap-3">
                    <p class="text-[10px] font-bold uppercase tracking-[0.2em] text-[#4A90A4]">Datos de la reserva</p>
                    <div class="h-px bg-stone-100 flex-1"></div>
                </div>

                <div class="space-y-4">
                    <div class="bg-stone-50/50 rounded-2xl p-5 border border-stone-100 hover:border-[#8B5E3C]/20 transition-colors">
                        <p class="text-[9px] font-bold uppercase tracking-widest text-stone-400 mb-1">Servicio contratado</p>
                        <p class="font-bold text-[#3E2F28] text-lg">{{ reserve.service.type|capitalize }}</p>
                        <p class="text-xs text-stone-400 mt-1">{{ reserve.service.basePrice }}‚Ç¨/pers ¬∑ {{ reserve.service.duration ? reserve.service.duration|date('H:i') : '‚Äî' }}h</p>
                    </div>

                    <div class="flex items-center gap-4 bg-stone-50/50 rounded-2xl p-5 border border-stone-100">
                        <div class="w-12 h-12 rounded-xl bg-white text-[#4A90A4] shadow-sm flex items-center justify-center text-xl shrink-0">üìÖ</div>
                        <div>
                            <p class="text-[9px] font-bold uppercase tracking-widest text-stone-400">Fecha y hora</p>
                            {% if reserve.service.isSponsorship %}
                                <p class="font-bold text-[#3E2F28]">Apadrinamiento permanente</p>
                            {% elseif reserve.reserveDate %}
                                <p class="font-bold text-[#3E2F28]">{{ reserve.reserveDate|date('d/m/Y') }} a las {{ reserve.reserveDate|date('H:i') }}h</p>
                            {% else %}
                                <p class="font-bold text-stone-300 italic">No especificada</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="flex items-center gap-4 bg-stone-50/50 rounded-2xl p-5 border border-stone-100">
                        <div class="w-12 h-12 rounded-xl bg-white text-[#764F32] shadow-sm flex items-center justify-center text-xl shrink-0">üê¥</div>
                        <div>
                            <p class="text-[9px] font-bold uppercase tracking-widest text-stone-400">Burro asignado</p>
                            {% if reserve.selectedDonkey %}
                                <p class="font-bold text-[#3E2F28] text-lg">{{ reserve.selectedDonkey.nombre }}</p>
                                <p class="text-xs text-stone-400">{{ reserve.selectedDonkey.race }}</p>
                            {% else %}
                                <p class="font-bold text-stone-300 italic">Pendiente de asignar</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {# Pago #}
                {% if reserve.pay %}
                    <div class="flex items-center gap-4 bg-emerald-50/50 rounded-2xl p-5 border border-emerald-100">
                        <div class="w-12 h-12 rounded-xl bg-white text-emerald-600 shadow-sm flex items-center justify-center text-xl shrink-0">üí≥</div>
                        <div>
                            <p class="text-[9px] font-bold uppercase tracking-widest text-emerald-600">Estado del Pago</p>
                            <p class="font-bold text-emerald-700 text-lg">{{ reserve.pay.total }}‚Ç¨ <span class="text-xs opacity-60 font-medium">via {{ reserve.pay.method }}</span></p>
                        </div>
                    </div>
                {% else %}
                    <div class="flex items-center gap-3 text-amber-600 bg-amber-50/50 px-5 py-4 rounded-2xl border border-amber-100 text-[10px] font-bold uppercase tracking-widest">
                        <span>‚ö†Ô∏è Pago no registrado</span>
                    </div>
                {% endif %}

                {# Total con estilo DonkeyTour #}
                {% set companionCount = details.companions is defined ? details.companions|length : 0 %}
                <div class="bg-[#3E2F28] rounded-[2rem] p-6 text-white shadow-lg shadow-stone-200">
                    <p class="text-stone-400 text-[9px] font-bold uppercase tracking-[0.3em] mb-2">Resumen financiero</p>
                    <div class="flex items-end justify-between">
                        <div>
                            <p class="text-3xl font-black">
                                {% if reserve.service.isSponsorship %}
                                    {{ reserve.service.basePrice }}‚Ç¨<span class="text-xs font-normal text-stone-400 italic">/mes</span>
                                {% else %}
                                    {{ reserve.service.basePrice * (1 + companionCount) }}‚Ç¨
                                {% endif %}
                            </p>
                        </div>
                        <p class="text-stone-400 text-[10px] font-bold uppercase">
                            {{ 1 + companionCount }} √ó {{ reserve.service.basePrice }}‚Ç¨
                        </p>
                    </div>
                </div>
            </div>

            {# ---- Participantes ---- #}
            <div class="bg-white/80 backdrop-blur-xl border border-stone-100 rounded-[2.5rem] p-8 shadow-sm space-y-6">
                <div class="flex items-center gap-3">
                    <p class="text-[10px] font-bold uppercase tracking-[0.2em] text-[#4A90A4]">Participantes</p>
                    <div class="h-px bg-stone-100 flex-1"></div>
                    <span class="text-[10px] font-bold text-stone-400 bg-stone-50 px-2 py-0.5 rounded-full border border-stone-100">{{ 1 + companionCount }} total</span>
                </div>

                {# Titular #}
                {% set booker = details.booker ?? reserve.bookedBy ?? null %}
                {% if booker %}
                    <div class="bg-[#8B5E3C]/5 rounded-3xl p-6 border border-[#8B5E3C]/10 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-3">
                            <span class="text-[8px] font-black uppercase tracking-widest text-white bg-[#8B5E3C] px-3 py-1 rounded-bl-xl rounded-tr-xl">Titular</span>
                        </div>
                        <p class="font-black text-[#3E2F28] text-xl">{{ booker.nombre }}</p>
                        <div class="grid grid-cols-1 gap-3 mt-4 text-xs">
                            <div class="flex items-center gap-2"><span class="text-stone-400 w-12 font-bold uppercase text-[9px]">Email</span> <span class="text-stone-600 font-medium">{{ booker.email }}</span></div>
                            <div class="flex items-center gap-2"><span class="text-stone-400 w-12 font-bold uppercase text-[9px]">NIF</span> <span class="text-stone-600 font-medium">{{ booker.nif }}</span></div>
                            <div class="flex items-center gap-2"><span class="text-stone-400 w-12 font-bold uppercase text-[9px]">Tel.</span> <span class="text-stone-600 font-medium">{{ booker.telefono }}</span></div>
                        </div>
                    </div>
                {% endif %}

                {# Acompa√±antes #}
                <div class="space-y-3">
                    {% if details.companions is defined and details.companions|length > 0 %}
                        {% for comp in details.companions %}
                            <div class="bg-stone-50/50 rounded-2xl p-5 border border-stone-100">
                                <p class="text-[9px] font-bold uppercase tracking-widest text-stone-400 mb-2">Acompa√±ante #{{ loop.index }}</p>
                                <p class="font-bold text-[#3E2F28]">{{ comp.nombre }}</p>
                                <p class="text-[10px] text-stone-400 mt-1 font-medium">NIF: {{ comp.nif ?: '‚Äî' }} ¬∑ Tel: {{ comp.telefono ?: '‚Äî' }}</p>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-10 border-2 border-dashed border-stone-100 rounded-3xl">
                            <p class="text-stone-300 text-xs font-bold uppercase tracking-widest italic">Sin acompa√±antes</p>
                        </div>
                    {% endif %}
                </div>

                {# Gu√≠a #}
                {% if reserve.employee %}
                    <div class="bg-sky-50/50 rounded-2xl p-5 border border-sky-100 flex items-center justify-between">
                        <div>
                            <p class="text-[9px] font-bold uppercase tracking-widest text-sky-600">Gu√≠a asignado</p>
                            <p class="font-bold text-[#3E2F28] mt-1">{{ reserve.employee.nombre }}</p>
                        </div>
                        <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-lg">üë§</div>
                    </div>
                {% endif %}
            </div>
        </div>

        <p class="text-center text-stone-300 text-[9px] font-bold uppercase tracking-[0.3em] pb-12">
            DonkeyTour CRM ‚Äî Granada, Espa√±a
        </p>
    </div>
</div>
{% endblock %}